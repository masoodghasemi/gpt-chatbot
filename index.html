<!DOCTYPE html>
<html>
<head>
  <title>GPT Chatbot for Tableau</title>
  <!-- Load Tableau Extensions API from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tableau-api@1.13.0/tableau.extensions.min.js"></script>
  <link rel="stylesheet" href="https://masoodghasemi.github.io/gpt-chatbot/style.css">
</head>
<body>
  <div id="chat-container">
    <h2>Ask GPT</h2>
    <input type="text" id="query-input" placeholder="e.g., What‚Äôs the trend for Sales?" />
    <button id="ask-button">Ask GPT</button>
    <div id="response">Awaiting input...</div>
  </div>

  <!-- Inline script logic -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const askBtn = document.getElementById("ask-button");
      const queryInput = document.getElementById("query-input");
      const responseDiv = document.getElementById("response");

      function logToUI(msg) {
        if (responseDiv) {
          responseDiv.innerText += "\\n" + msg;
        }
        console.log(msg);
      }

      logToUI("‚úÖ Inline script loaded");

      if (!askBtn || !queryInput || !responseDiv) {
        logToUI("‚ùå Missing DOM elements");
        return;
      }

      askBtn.addEventListener("click", async () => {
        logToUI("üü¢ Ask GPT clicked");

        const query = queryInput.value.trim();
        if (!query) {
          responseDiv.innerText = "‚ùå Please enter a question.";
          return;
        }

        responseDiv.innerText = "Thinking...";
        logToUI("üì• Query: " + query);

        try {
          await tableau.extensions.initializeAsync();

          // Force target "Sheet 1"
          const worksheet = tableau.extensions.dashboardContent.dashboard.worksheets.find(ws => ws.name === "Sheet 1");
          if (!worksheet) {
            logToUI("‚ùå Worksheet 'Sheet 1' not found.");
            responseDiv.innerText = "‚ùå Could not find 'Sheet 1'.";
            return;
          }

          const summary = await worksheet.getSummaryDataAsync();
          const cols = summary.columns.map(col => col.fieldName);
          logToUI("üß© Columns found: " + cols.join(", "));

          const data = summary.data.map(row =>
            Object.fromEntries(row.map((cell, i) => [cols[i], cell.formattedValue]))
          );

          logToUI("üìä First row: " + JSON.stringify(data[0] || {}));
          logToUI("üìà Total rows: " + data.length);

          const fullPrompt = `
You're assisting a user looking at a Tableau worksheet titled 'Sheet 1'.

They asked: "${query}"

Here is a sample of the worksheet data (up to 30 rows):
${JSON.stringify(data.slice(0, 30), null, 2)}

Use the column names and values to answer intelligently.
          `.trim();

          logToUI("üßæ Prompt:\n" + fullPrompt);

          const res = await fetch("https://gpt-proxy-5hrz.onrender.com/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: fullPrompt })
          });

          if (!res.ok) throw new Error("HTTP " + res.status);
          const result = await res.json();

          logToUI("ü§ñ GPT says: " + result.response);
          responseDiv.innerText = result.response || "‚ùå No response.";
        } catch (err) {
          logToUI("‚ùå Error: " + err.message);
          responseDiv.innerText = "‚ùå GPT call failed.";
        }
      });
    });
  </script>
</body>
</html>
