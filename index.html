<script>
  document.addEventListener("DOMContentLoaded", () => {
    const askBtn = document.getElementById("ask-button");
    const queryInput = document.getElementById("query-input");
    const responseDiv = document.getElementById("response");

    function logToUI(msg) {
      if (responseDiv) {
        responseDiv.innerText += "\n" + msg;
      }
      console.log(msg);
    }

    // DEBUG: Check if tableau is available
    if (typeof tableau === "undefined") {
      logToUI("❌ DEBUG: Tableau object is NOT defined. Extension not running inside Tableau.");
      return;
    } else {
      logToUI("✅ DEBUG: Tableau object is available.");
    }

    askBtn.addEventListener("click", async () => {
      const query = queryInput.value.trim();
      if (!query) {
        responseDiv.innerText = "❌ Please enter a question.";
        return;
      }

      responseDiv.innerText = "Thinking...";
      logToUI("📥 Query: " + query);

      try {
        await tableau.extensions.initializeAsync();
        logToUI("✅ Tableau extension initialized");

        const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
        if (!worksheets || worksheets.length === 0) {
          throw new Error("No worksheets found in dashboard.");
        }

        const worksheet = worksheets[0]; // Use first worksheet
        logToUI("📄 Using worksheet: " + worksheet.name);

        const summaryData = await worksheet.getSummaryDataAsync();
        const columns = summaryData.columns.map(col => col.fieldName);

        const structuredData = summaryData.data.map(row => {
          const rowData = {};
          row.forEach((cell, i) => {
            rowData[columns[i]] = cell.formattedValue;
          });
          return rowData;
        });

        logToUI("📊 Structured Data:\n" + JSON.stringify(structuredData, null, 2));

        const res = await fetch("https://gpt-proxy-5hrz.onrender.com/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: query,
            worksheet_data: structuredData
          })
        });

        const result = await res.json();
        responseDiv.innerText = result.response || "❌ GPT returned no response.";
      } catch (err) {
        logToUI("❌ Error: " + err.message);
        responseDiv.innerText = "❌ Failed: " + err.message;
      }
    });
  });
</script>
