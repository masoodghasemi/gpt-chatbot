<script>
  document.addEventListener("DOMContentLoaded", () => {
    const askBtn = document.getElementById("ask-button");
    const queryInput = document.getElementById("query-input");
    const responseDiv = document.getElementById("response");

    function logToUI(msg) {
      if (responseDiv) {
        responseDiv.innerText += "\n" + msg;
      }
      console.log(msg);
    }

    logToUI("‚úÖ Extension loaded.");

    if (typeof tableau === "undefined") {
      logToUI("‚ùå Tableau Extensions API is not available.");
      return;
    }

    askBtn.addEventListener("click", async () => {
      const query = queryInput.value.trim();
      if (!query) {
        responseDiv.innerText = "‚ùå Please enter a question.";
        return;
      }

      responseDiv.innerText = "Thinking...";
      logToUI("üì• Query: " + query);

      try {
        await tableau.extensions.initializeAsync();
        logToUI("‚úÖ Tableau extension initialized");

        const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
        if (!worksheets || worksheets.length === 0) {
          throw new Error("No worksheets found in dashboard.");
        }

        const worksheet = worksheets[0];
        logToUI("üìÑ Using worksheet: " + worksheet.name);

        const summaryData = await worksheet.getSummaryDataAsync();
        const columns = summaryData.columns.map(col => col.fieldName || col.alias || `Col${i}`);

        const structuredData = summaryData.data.map(row => {
          const rowData = {};
          row.forEach((cell, i) => {
            const rawValue = cell.formattedValue;
            const numeric = parseFloat(rawValue.toString().replace(/,/g, ''));
            rowData[columns[i]] = isNaN(numeric) ? rawValue : numeric;
          });
          return rowData;
        });

        console.log("üìä Structured Data Sample:", structuredData.slice(0, 5)); // log only in dev tools

        const res = await fetch("https://gpt-proxy-5hrz.onrender.com/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: query,
            worksheet_data: structuredData,
            columns: columns
          })
        });

        const result = await res.json();
        responseDiv.innerText = result.response || "‚ùå GPT returned no response.";
      } catch (err) {
        console.error("‚ùå Error:", err);
        responseDiv.innerText = "‚ùå Error: " + err.message;
      }
    });
  });
</script>
